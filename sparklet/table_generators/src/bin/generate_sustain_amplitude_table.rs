use std::env;

use fixed::{
    traits::{FromFixed, ToFixed},
    types::I1F31,
};

fn main() {
    let args: Vec<String> = env::args().collect();

    let starting_level = args.get(1).and_then(|s| s.parse().ok()).unwrap_or(-40.);
    assert!(starting_level < 0.);

    eprintln!("Generating perecptually linear sustain table:");
    eprintln!("  STARTING_LEVEL: {} db", starting_level);

    const SIZE: usize = 256;

    let mut sustain_amplitude_table: [I1F31; SIZE] = [Default::default(); SIZE];

    let mut sanity_check_data = vec![];

    for (index, sustain_amplitude) in sustain_amplitude_table.iter_mut().enumerate() {
        if index == 0 {
            *sustain_amplitude = I1F31::ZERO;
            continue;
        }

        // A\left(c\right)=10^{\frac{N+\frac{-N}{l}c}{20}}

        let amplitude = (10_f64)
            .powf((starting_level - starting_level / (SIZE as f64 - 1.) * index as f64) / 20.);
        if amplitude > f64::from_fixed(I1F31::MAX) {
            *sustain_amplitude = I1F31::MAX;
        } else {
            *sustain_amplitude = amplitude.to_fixed();
        }

        if index <= 3 || (126..=128).contains(&index) || 253 <= index {
            sanity_check_data.push((
                index,
                f64::from_fixed(*sustain_amplitude),
                20. * f64::log10(f64::from_fixed(*sustain_amplitude)),
            ));
        }
    }

    let contents = format!(
        "// Autogenerated by generate_sustain_amplitude_table

use fixed::types::I1F31;

pub static DB_LINEAR_AMPLITUDE_TABLE: [I1F31; {}] = [
    {}
];
",
        SIZE,
        i1f31_table_to_string(&sustain_amplitude_table),
    );

    println!("{}", contents);

    eprintln!();
    eprintln!("Sanity check (index, time, final_value):");
    for (index, amplitude, level) in &sanity_check_data {
        eprintln!(
            "    Index {:3}: amplitude={:.3}, level={:.3} db",
            index, amplitude, level
        );
    }
}

pub fn i1f31_table_to_string(table: &[I1F31]) -> String {
    table
        .iter()
        .map(|n| std::format!("I1F31::from_bits({:#010x}_u32 as i32)", n.to_bits() as u32))
        .reduce(|acc, s| std::format!("{},\n{}", acc, s))
        .unwrap_or("".to_string())
}
